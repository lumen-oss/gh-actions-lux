{"version":3,"file":"index.js","sources":["../src/installer.ts","../src/main.ts","../src/index.ts"],"sourcesContent":["import { join as pathJoin } from 'path'\nimport { Env, FileSystem, Handle, OS, UnsupportedTargetError } from './ports.js'\n\nexport interface Installer {\n  install(assetPath: string): Promise<void>\n}\n\nexport function createInstaller(handle: Handle): Installer {\n  const env = handle.getEnv()\n  switch (env.getTarget()) {\n    case 'x86_64-linux':\n    case 'aarch64-linux':\n      return createDebInstaller(handle.getFileSystem(), handle.getOS())\n    case 'aarch64-macos':\n      return createDmgInstaller(env, handle.getFileSystem(), handle.getOS())\n    case 'x86_64-windows':\n      return createExeInstaller(env, handle.getFileSystem(), handle.getOS())\n    default:\n      throw new UnsupportedTargetError(\n        `no installer available for target: ${String(env.getTarget())}`\n      )\n  }\n}\n\nclass DebInstaller implements Installer {\n  private readonly filesystem: FileSystem\n  private readonly os: OS\n\n  constructor(fs: FileSystem, os: OS) {\n    this.filesystem = fs\n    this.os = os\n  }\n\n  async install(assetPath: string): Promise<void> {\n    await this.filesystem.access_read(assetPath)\n    await this.os.exec('sudo', ['dpkg', '-i', assetPath])\n  }\n}\n\nfunction createDebInstaller(fs: FileSystem, os: OS): Installer {\n  return new DebInstaller(fs, os)\n}\n\nclass DmgInstaller implements Installer {\n  private readonly env: Env\n  private readonly filesystem: FileSystem\n  private readonly os: OS\n\n  constructor(env: Env, fs: FileSystem, os: OS) {\n    this.env = env\n    this.filesystem = fs\n    this.os = os\n  }\n\n  async install(assetPath: string): Promise<void> {\n    await this.filesystem.access_read(assetPath)\n    const workDir = await this.filesystem.mkdtemp('lux-dmg-')\n    // We need to convert to UDTO, to prevent a prompt to accept the license.\n    const converted = pathJoin(workDir, 'converted.cdr')\n    const mountPoint = '/Volumes/install_app'\n    let mounted = false\n    try {\n      await this.os.exec('hdiutil', [\n        'convert',\n        '-quiet',\n        assetPath,\n        '-format',\n        'UDTO',\n        '-o',\n        converted\n      ])\n      await this.os.exec('hdiutil', [\n        'attach',\n        '-nobrowse',\n        '-noverify',\n        '-mountpoint',\n        mountPoint,\n        converted\n      ])\n      mounted = true\n      const entries = await this.filesystem.readdir(mountPoint)\n      const app = entries.find((e) => e.endsWith('.app'))\n      if (!app) throw new Error(`no .app bundle found at ${mountPoint}`)\n      const src = pathJoin(mountPoint, app)\n      await this.filesystem.copyRecursive(src, '/Applications/')\n      const lx_app_dir = pathJoin('/Applications', app, 'Contents', 'MacOS')\n      this.env.addPath(lx_app_dir)\n    } finally {\n      if (mounted) {\n        try {\n          await this.os.exec('hdiutil', ['detach', mountPoint])\n        } catch {\n          /* best-effort */\n        }\n      } else {\n        try {\n          await this.os.exec('hdiutil', ['detach', workDir])\n        } catch {\n          /* best-effort */\n        }\n      }\n      try {\n        await this.filesystem.unlink(converted)\n      } catch {\n        /* ignore cleanup errors */\n      }\n    }\n  }\n}\n\nfunction createDmgInstaller(env: Env, fs: FileSystem, os: OS): Installer {\n  return new DmgInstaller(env, fs, os)\n}\n\nclass ExeInstaller implements Installer {\n  private readonly env: Env\n  private readonly filesystem: FileSystem\n  private readonly os: OS\n\n  constructor(env: Env, fs: FileSystem, os: OS) {\n    this.env = env\n    this.filesystem = fs\n    this.os = os\n  }\n\n  async install(assetPath: string): Promise<void> {\n    await this.filesystem.access_read(assetPath)\n\n    const installDir = pathJoin('c:', 'Program Files', 'lux')\n    try {\n      await this.os.exec('powershell.exe', [\n        '-NoProfile',\n        '-WindowStyle',\n        'Hidden',\n        'Start-Process',\n        assetPath,\n        '-Wait',\n        '-ArgumentList',\n        `/P, /D=\"${installDir}\"`\n      ])\n    } catch (err) {\n      throw new Error(\n        `failed to perform silent install for ${assetPath}:\\n\\n${err}`\n      )\n    }\n    this.env.addPath(installDir)\n  }\n}\n\nfunction createExeInstaller(env: Env, fs: FileSystem, os: OS): Installer {\n  return new ExeInstaller(env, fs, os)\n}\n","import type { Handle } from './ports.ts'\nimport { GitHubActionsHandle } from './io/handle.js'\nimport { collectConfig } from './inputs.js'\nimport { join as pathJoin } from 'path'\nimport { createInstaller } from './installer.js'\n\nexport async function run(handle?: Handle): Promise<void> {\n  handle = handle ?? new GitHubActionsHandle()\n  const env = handle.getEnv()\n  const lux_provider = handle.getLuxProvider()\n  const filesystem = handle.getFileSystem()\n  const downloader = handle.getDownloader()\n  const cache = handle.getCache()\n  try {\n    const config = collectConfig(env)\n    env.debug(`Parsed inputs: ${JSON.stringify(config)}`)\n    env.debug(`Running on ${env.getTarget()}`)\n    const version = env.getVersionInput()\n\n    await cache.restore(version)\n\n    const lux_release = await lux_provider.getRelease(version)\n    const installer_asset = lux_release.assetForTarget(env.getTarget())\n    env.info(\n      `Found installer release asset: ${JSON.stringify(installer_asset)}`\n    )\n    env.info(`Downloading Lux ${lux_release.version} installer...`)\n    const tmpDir = await filesystem.mkdtemp('lux-')\n    const installer_asset_path = pathJoin(tmpDir, installer_asset.file_name)\n    await downloader.download_installer_asset(\n      installer_asset,\n      installer_asset_path\n    )\n    env.info(\n      `Downloaded ${installer_asset.file_name} to ${installer_asset_path}`\n    )\n    env.info(`Installing Lux ${lux_release.version}...`)\n    const installer = createInstaller(handle)\n    await installer.install(installer_asset_path)\n    env.info('Done.')\n  } catch (error) {\n    if (error instanceof Error) {\n      env.setFailed(error.message)\n    } else {\n      env.setFailed(`unexpected error: ${JSON.stringify(error)}`)\n    }\n  }\n}\n","import { run } from './main.js'\n\n/* istanbul ignore next */\nrun()\n"],"names":["pathJoin"],"mappings":"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"}